<p align="center">
  <a href="../README.md">English</a> | <strong>繁體中文</strong> | <a href="./README-ja-JP.md">日本語</a>
</p>

# Menu Builder for Maya

**3DアーティストとプロジェクトTAのために設計された、ビジュアルなMayaメニュー編集・管理ツール。**

## プロジェクトの目標

`menubuilder`は、Mayaユーザー（特にプロジェクトチーム内）が増え続ける外部スクリプトやツールを管理する際の課題を解決することを目指しています。 従来のシェルフはツールの数が増えるにつれて煩雑になり、アーティストにとって手動でメニュースクリプトを作成するのはハードルが高すぎます。

このツールは直感的なグラフィカルインターフェースを提供し、ユーザーが散在するPython/MELスクリプトをMayaのメインメニューバーに簡単に統合できるようにします。 また、チーム全体で標準化されたツールセットを容易に作成、共有、展開できます。

## 主な機能

* **ビジュアル編集:** ツリービューを通じて、メニューの階層と順序を直感的にプレビュー・調整できます。
* **ドラッグ＆ドロップによるソート:** ツリービュー内で項目を直接ドラッグ＆ドロップすることで、「見たまま」のソートを実現します。
* **クイック操作:** ダブルクリックによる編集、右クリックメニュー、直接リネームなどの方法で、メニュー構造を迅速に修正・整理できます。
* **オプションボックス:** 右クリックメニューを通じて、Maya標準のオプションボックス機能を簡単に作成・管理できます。
* **セパレーター:** 右クリックメニューを通じて、Maya標準の区切り線を簡単に作成・管理できます。
* **スクリプト解析:** `.py`ファイルを自動的に解析し、利用可能なすべての関数をリストアップして、コマンドの追加を簡素化します。
* **コマンド統合:** PythonとMELの両言語をサポートし、テスト実行機能も提供します。
* **アイコンセレクター:** Maya内蔵のアイコンブラウザとローカルファイルの参照機能を搭載し、ツールにアイコンを簡単に追加し、リアルタイムでプレビューできます。
* **ファイル管理:** 異なるメニュー設定ファイル（`.json`）のオープン、マージ、名前を付けて保存をサポートし、管理を容易にします。
* **チーム展開:** 軽量な起動スクリプトを提供し、チームメンバーがエディタを開くことなく、Maya起動時に自動的にメニューを生成できるようにします。

## インストールと使用方法

### **A) 「メニュー開発者 / TA」向け（エディタを開く）**

このフローは、メニュー設定ファイルを作成・編集するために使用します。

1.  **プロジェクトの配置:** `menubuilder`プロジェクトフォルダ全体を、固定された英数字のみのパス（例：`D:/maya-tools/menubuilder`）に配置します。

2.  **Mayaにパスを通知:** Mayaが`import menubuilder`できるように、プロジェクトのパスをMayaの`PYTHONPATH`環境変数に追加する必要があります。 最も簡単な方法は`Maya.env`ファイルを編集することです。
    * **`Maya.env`を見つける:** 通常、`C:/Users/<ユーザー名>/Documents/maya/<バージョン>/`にあります。
    * **ファイルを編集:** ファイルの末尾に以下の行を追加します（PYTHONPATHが既に存在する場合は追記します）。 パスは`menubuilder`フォルダの**親ディレクトリ**です。
        ```
        PYTHONPATH = D:/maya-tools
        ```
    * 変更後はMayaを**再起動**する必要があります。

3.  **起動と開発:** Mayaを再起動した後、Pythonスクリプトエディタで以下のコマンドを実行します。
    ```python
    import menubuilder
    
    # 初回起動または通常使用
    menubuilder.show()
    
    # --- 開発フロー ---
    # menubuilderのソースコードを変更した後、
    # Mayaを再起動する必要はありません。以下のコマンドを実行して
    # 全てのモジュールをリロードしてください。
    menubuilder.reload
    menubuilder.show()
    ```

### **B) 「メニュー使用者 / アーティスト」向け（展開）**

このフローは、設定済みのメニューをチームメンバーに展開するために使用します。 彼らがMayaを起動すると、メニューが自動的に生成されます。

1.  **TA/開発者による準備:**
    * `menubuilder`エディタを使用して、チームが必要とするメニュー設定を`.json`ファイルとして保存します（例：`project_menu.json`）。
    * `settings.json`を開き、`"menuitems"`の値がチームにデフォルトでロードさせたいファイル名になっていることを確認します（例：`"menuitems": "project_menu"`）。
    * `menubuilder`プロジェクトフォルダ全体を使用者に提供します。

2.  **使用者の操作:**
    * `menubuilder`フォルダを固定パス（例：ネットワークドライブ`P:/tools/menubuilder`またはローカル`D:/maya-tools/menubuilder`）に配置します。
    * `userSetup.py`ファイルを見つけるか作成します。 場所は以下の通りです：
        `C:/Users/<ユーザー名>/Documents/maya/scripts/userSetup.py`
    * `userSetup.py`に以下のコードを追加し、**`project_folder_path`が正しいパスを指していることを確認してください**。

    ```python
    # userSetup.py
    import maya.cmds as cmds
    import sys
    import os

    try:
        # --- Menubuilder Auto-Load ---
        # 
        # [重要] このパスを、ご自身のmenubuilderプロジェクトが
        # 格納されているフォルダのパスに変更してください。
        #
        project_folder_path = r"D:\maya-tools\menubuilder" # <-- 修正が必要なのはこの行だけです
        
        # パスが存在するか確認し、MayaのPython検索パスに追加します
        if os.path.isdir(project_folder_path) and project_folder_path not in sys.path:
            sys.path.append(project_folder_path)
            
            # evalDeferredを使用し、Mayaが完全に起動した後にメニュー生成を実行します。
            # これはメニューを含むUIを作成する際の標準的で安全な方法です。
            cmds.evalDeferred("from menubuilder import setup_maya_menu; setup_maya_menu.build_menus_on_startup()")
            
    except Exception as e:
        cmds.warning(f"[Menubuilder Startup] Failed to load menus: {e}")
    # --- End Menubuilder ---
    ```

3.  **完了:** 次回ユーザーがMayaを起動すると、あなたが設定したメニューが自動的に生成されます。

## Menubuilderフレームワークガイド

### ファイル構造

```
menubuilder/
├── init.py           # メインエントリポイント (reload, showを含む)
├── setup_maya_menu.py    # チーム展開用の起動スクリプト
├── README.md             # ドキュメント
├── settings.json         # ツールのグローバル設定
│
├── core/                   # コア機能モジュール
│   ├── controller.py     # コントローラー (コアロジック)
│   ├── ui.py             # UI定義
│   ├── data_handler.py   # データ処理 (jsonの読み書き)
│   ├── menu_generator.py # Mayaメニュー生成
│   ├── script_parser.py  # スクリプトパーサー
│   ├── dto.py            # データ転送オブジェクト (MenuItemData)
│   └── logger.py         # ログシステム
│
├── docs/                  # ドキュメント
│
└── menuitems/              # 全てのメニュー設定ファイル (.json) を格納
    └── personal_menubar.json # デフォルトの個人用メニュー設定
```

## UIレイアウト

### 左側：メニュー構造パネル

**ツリービュー (Menu Structure)：この領域には、現在のメニュー設定ファイルの完全な階層構造が表示されます。 ここで以下の操作が可能です：**

* 項目をドラッグして順序や階層を変更する。
* 項目を右クリックして、追加や削除などの構造的な操作を行う。
* 項目をダブルクリックして、右側のパネルにそのプロパティをロードして編集する。

### 右側：プロパティ編集パネル

**コマンドソース (Input Tabs):**

* **ファイルから解析:** `.py`スクリプトを参照・読み込み、ツールが自動的にその中の全関数をリストアップして、素早く選択できるようにします。
* **コマンド手動入力:** PythonまたはMELスクリプトを直接貼り付けたり記述したりするために使用します。

**コマンド編集エリア:**

* **コマンド言語:** 入力したコマンドがPythonかMELかを選択します。
* **コマンド入力ボックス:** メニュー項目に実行させたいコードを記述または貼り付けます。
* **テスト実行ボタン:** メニューを生成せずに、入力ボックス内のコマンドを即座に実行し、Mayaのスクリプトエディタで結果やエラーメッセージを確認して、デバッグを容易にします。

**プロパティエディタ (Attribute Editor):**

* **ラベル (Label):** Mayaで表示されるメニュー項目の名前を定義します。
* **パス (Path):** メニュー項目の階層パスを`/`で区切って定義します（例：`Tools/Rigging`）。 空欄の場合はトップレベルメニューになります。
* **アイコン (Icon):** メニュー項目にアイコンを割り当てます。 「カスタム...」をクリックしてローカル画像を参照するか、「内蔵...」をクリックしてMaya内蔵のアイコンライブラリを参照します。

## 中核となるワークフロー
### A. 新しい項目を追加する

* **位置特定:** 左側のツリービューで、項目を追加したい場所を見つけます。
* **ルート項目を追加:** ツリービューの空白部分を右クリックし、「ルート項目を追加...」を選択します。
* **子項目を追加:** フォルダを右クリックし、「項目を追加...」を選択します。
* **同階層に項目を追加:** 機能項目や区切り線を右クリックし、「項目を追加...」を選択します。
* **プロパティを記入:** 右側の編集パネルがクリアされます（メニューパスは自動入力されます）。 「ラベル」、「コマンド」などの情報を順次入力します。
* **コマンドをテスト:** 「テスト実行」ボタンをクリックし、スクリプトが正常に動作することを確認します。
* **追加を完了:** 「構造に追加」ボタンをクリックすると、新しい項目が左側のツリービューに表示されます。

### B. 既存の項目を編集する

* **編集モードに入る:** 左側のツリービューで、編集したい項目をダブルクリックします。
* **変更を確認:**
    * 左側のツリービューが無効化（グレーアウト）され、ドラッグなどの競合操作が防止されます。
    * 右側のパネルにその項目のすべてのプロパティが読み込まれます。
    * 「構造に追加」ボタンが「更新 | 編集を終了」ボタンに変わり、視覚的な合図として色が変わることがあります。
* **プロパティを修正:** 右側のパネルで必要なプロパティを修正します。
* **編集を完了:**
    * 「更新 | 編集を終了」ボタンをクリックして変更を保存します。
    * または、`ESC`キーを押して変更を破棄します。
* **編集モードを終了:** 操作が完了すると、左側のツリービューが自動的に再び有効になります。

### C. オプションボックスの管理

**オプションボックスの作成:**
* オプションボックスとして設定したい項目が、有効な「親」メニュー項目の真下にあることを確認します。
* その項目を右クリックし、「オプションボックスとして設定」を選択します。

**オプションボックスの解除:**
* 既にオプションボックスである項目を右クリックし、「オプションボックスの状態を解除」を選択します。

### D. 整理とソート

編集モードでない時（つまり、左側のツリービューがクリック可能な時）、任意の機能項目、親項目、またはフォルダを自由にドラッグして、順序や所属するフォルダを変更できます。
このツールには、無効なドラッグ＆ドロップ操作（例：項目を別の機能項目の下にドロップする、親項目とそのオプションボックスの間に項目を挿入する）を防ぐためのロジックが組み込まれています。

### E. 保存と生成

* **設定ファイルの保存:** レイアウトに満足したら、右下隅の「設定ファイルを保存」ボタンをクリックします。 すべての変更が`.json`ファイルに書き込まれます。
* **Mayaでプレビュー:** 一番下の「✨ Mayaでメニューを生成/更新」ボタンをクリックします。 Menubuilderは古いカスタムメニューを自動的にクリアし、現在の設定に基づいてMayaのメインウィンドウの上部に新しいメニューを生成します。 このボタンをいつでもクリックして変更の効果をプレビューできます。

---
*このドキュメントはMenubuilder AI Assistantによって生成されました。2025年8月*